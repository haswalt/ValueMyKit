var vmk={amazon:{id:"0QKNT33QJ8T5NYMAYP02",s:"w6olv/GbYYZkD9QZTJa7dvt2SLczvJxficFQkdgk",limit:3},ebay:{id:"LQDInter-d3b1-490b-8acc-d6c9a8c08c6a",perPage:"1000"},alertTimer:null,products:[],productId:0,priceDeviance:"0.10",init:function(){$("#we").find("p").fadeOut("fast",function(){$("#we").find("form").slideDown()});$("#we").delegate("form","submit",function(){product=$(this).find("input[name=q]").val();if(product.length<2){vmk.alertBar("You product name is too short!");return false}$("#we").slideUp();$("#p").slideDown();vmk.productLookup(product,$(this).find("select").val());return false})},getc:function(){$("#p").slideUp(function(){$("#c").slideDown(function(){$("#t").find("li").removeClass("a").filter(":nth-child(2)").addClass("a")})});$("#c").delegate("form","submit",function(){vmk.getPrices($(this).find("select").val());return false})},getPrices:function(f){$("#c").slideUp(function(){$("#t").find("li").removeClass("active").filter(":last").addClass("active");$("#e").slideDown()});var a="",d="",e="",b="";a="http://svcs.ebay.com/services/search/FindingService/v1?";d="OPERATION-NAME=findItemsAdvanced&SERVICE-VERSION=1.0.0&RESPONSE-DATA-FORMAT=JSON&SECURITY-APPNAME="+this.ebay.id+"&GLOBAL-ID=EBAY-US&REST-PAYLOAD&paginationInput.entriesPerPage="+this.ebay.perPage+"&itemFilter(0).name=Condition&itemFilter(0).value(0)="+f+"&SoldItemsOnly=true";e=vmk.products[vmk.productId].ItemAttributes.Title.replace(/\(.[^\)]*\)/,"");b=a+d+'&keywords="'+encodeURIComponent(e)+'"&callback=?';$.getJSON(b,function(l){var g=new Array(),m=new Array(),c=new Array();var t=0,n=0,u=0,q=0,j=0,r=0,p=0,k=0,s=0,o=0,h=0;if(l.findItemsAdvancedResponse[0].searchResult[0]["@count"]==0||typeof(l.findItemsAdvancedResponse[0].searchResult[0]["@count"])=="undefined"){$("#e").slideUp(function(){$("#p").html("Loading...");$("#we").slideDown()});vmk.alertBar("Sorry, we could not calculate an estimate","error")}for(n in l.findItemsAdvancedResponse[0].searchResult[0].item){result=l.findItemsAdvancedResponse[0].searchResult[0].item[n];p=parseFloat(result.sellingStatus[0].currentPrice[0]["__value__"]);m.push(p);t+=+p}u=t/m.length;q=u*vmk.priceDeviance;j=u-q;r=u+q;for(n in m){p=m[n];if(p>=j&&p<=r){c.push(p)}}c.sort(vmk.asc);k=c[0];s=c[c.length-1];for(n in c){p=c[n];if(typeof(g[p])!="undefined"){g[p]++}else{g[p]=1}if(g[p]>h){h=g[p];o=p}else{if(g[p]==h&&p>o){o=p}}}if(o<1){o=u.toFixed(2)}$("#e").html("<h2>We estimate your kit is worth &pound;"+o+"</h2><h3>We found it available between &pound;"+k+" and &pound;"+s+"</h3>")})},productLookup:function(f,d){var b="",a="",e="",c="";b="http://query.yahooapis.com/v1/public/yql?q=";a='USE "http://www.datatables.org/amazon/amazon.ecs.xml" AS amazon.ecs;';e="SELECT ItemAttributes.Title, MediumImage.URL, Offers.Offer.OfferListing.Price FROM amazon.ecs("+this.amazon.productLimit+') WHERE Operation = "ItemSearch" AND SearchIndex = "'+d+'" AND ResponseGroup = "Medium,Offers" AND AWSAccessKeyId = "'+this.amazon.id+'" AND secret = "'+this.amazon.s+'" AND Keywords = "'+f+'"';c=b+encodeURIComponent(a+e)+"&format=json&callback=?";$.getJSON(c,this.parseAmazonProducts)},parseAmazonProducts:function(e){var c=0,d="",b="",a="";if(e.query.results==null||e.query.results.Item.length<1){$("#p").slideUp();$("#we").slideDown();vmk.alertBar("No Products found!","error");return false}$("#we").slideUp();$("#p").slideDown();$("#p").html("<h2>Please select the product closest to the your item</h2>");for(c in e.query.results.Item){d=e.query.results.Item[c];if(typeof(d.ItemAttributes)!="undefined"){a='<div class="no-image">No Product Image</div>';if(typeof(d.MediumImage)!="undefined"){a='<img src="'+d.MediumImage.URL+'" width="108">'}detail=$("<ul><li>"+a+"</li><li><h3>"+d.ItemAttributes.Title+"</h3><hr><p><a href=# data-pid="+c+" class=b>Choose</a></li></ul><div style=clear:both></div>");detail.hide();$("#p").append(detail);detail.slideDown();vmk.products[c]=d}}if(vmk.products.length<1){$("#p").slideUp();$("#we").slideDown();vmk.alertBar("No Products found!","error");return false}$("#p").delegate("a.b","click",function(){vmk.productId=$(this).attr("data-pid");vmk.getc();return false})},alertBar:function(b,a){$("#al").html(b).slideDown(500);clearTimeout(vmk.alertTimer);vmk.alertTimer=setTimeout(function(){$("#al").slideUp(300)},2000)},asc:function(d,c){return(d-c)}};